<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' gap: data: blob: filesystem:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'; media-src *">
    <title>Wise Voice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800;900&display=swap" rel="stylesheet">
    <script src="cordova.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 'wise-lime': '#8ED865', 'wise-dark': '#163300', 'wise-forest': '#254E3A', 'wise-gray': '#F2F5F8' },
                    animation: { 'blob': 'blob 10s infinite', 'fade-up': 'fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards', 'scale-in': 'scaleIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards' },
                    keyframes: {
                        blob: { '0%': { transform: 'translate(0px, 0px) scale(1)' }, '33%': { transform: 'translate(30px, -50px) scale(1.1)' }, '66%': { transform: 'translate(-20px, 20px) scale(0.9)' }, '100%': { transform: 'translate(0px, 0px) scale(1)' } },
                        fadeUp: { '0%': { opacity: '0', transform: 'translateY(40px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #8ED865; color: #163300; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }
        .wise-headline { font-weight: 900; line-height: 0.85; letter-spacing: -0.06em; }
        .smooth-hover { transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .smooth-hover:hover { transform: scale(1.04) translateY(-2px); box-shadow: 0 20px 40px -10px rgba(22, 51, 0, 0.2); }
        .smooth-hover:active { transform: scale(0.96); }
        .btn-primary { background-color: #163300; color: #ffffff; border: 2px solid #163300; }
        .btn-secondary { background-color: #ffffff; color: #163300; border: 2px solid #ffffff; }
        .keypad-btn { font-size: 1.5rem; font-weight: 600; border-radius: 50%; width: 72px; height: 72px; display: flex; align-items: center; justify-content: center; background-color: rgba(255,255,255,0.2); border: 1px solid rgba(22, 51, 0, 0.1); transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .keypad-btn:active { background-color: #163300; color: white; transform: scale(0.9); }
        .visualizer-orb { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; background: #163300; transition: all 0.1s ease; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden relative selection:bg-black selection:text-wise-lime">

    <div class="fixed inset-0 opacity-20 pointer-events-none mix-blend-overlay" style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noiseFilter%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.65%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noiseFilter)%22/%3E%3C/svg%3E');"></div>
    <div class="fixed top-[-15%] right-[-15%] w-[500px] h-[500px] bg-white/30 rounded-full blur-3xl -z-10 animate-blob"></div>
    <div class="fixed bottom-[-15%] left-[-15%] w-[400px] h-[400px] bg-emerald-900/10 rounded-full blur-3xl -z-10 animate-blob animation-delay-2000"></div>

    <div id="connection-status" class="hidden absolute top-6 right-6 z-30 animate-fade-up">
        <div class="flex items-center gap-2 px-4 py-2 bg-white/90 backdrop-blur-sm rounded-full shadow-lg">
            <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-400"></div>
            <span id="status-text" class="text-xs font-bold uppercase tracking-wide opacity-80">Offline</span>
        </div>
    </div>

    <main class="flex-1 w-full max-w-lg mx-auto p-6 relative z-10 flex flex-col justify-center">
        <!-- Reconnecting Warning -->
        <div id="reconnecting-warning" class="hidden absolute top-6 left-6 right-6 z-50 p-4 bg-yellow-100/90 backdrop-blur-md rounded-2xl border border-yellow-200 flex items-center justify-center gap-3 shadow-xl animate-fade-up">
            <div class="w-2 h-2 rounded-full bg-yellow-500 animate-ping"></div>
            <span class="font-bold text-sm text-yellow-900">Reconnecting...</span>
        </div>

        <!-- SCREEN 1: MODE SELECTION -->
        <div id="screen-mode" class="flex flex-col h-full justify-between py-12">
            <div class="flex-1 flex flex-col justify-center">
                <h1 class="text-[5rem] sm:text-[6rem] wise-headline text-wise-dark mb-8 tracking-tighter opacity-0 animate-fade-up" style="animation-delay: 0.1s;">
                    Voice<br>calls<br>
                    <span class="text-white relative inline-block">securely
                        <div class="absolute bottom-[10%] left-[-2%] w-[104%] h-[5px] bg-wise-dark"></div>
                    </span><br>encrypted.
                </h1>
            </div>
            <div class="space-y-4 mb-4 opacity-0 animate-fade-up" style="animation-delay: 0.5s;">
                <button onclick="goToHost()" class="w-full btn-primary h-20 rounded-[2rem] font-bold text-xl flex items-center justify-between px-8 smooth-hover group">
                    <span>Create a room</span>
                    <span class="bg-white/20 p-2 rounded-full group-hover:rotate-45 transition-transform duration-300"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></span>
                </button>
                <button onclick="goToJoin()" class="w-full btn-secondary h-20 rounded-[2rem] font-bold text-xl flex items-center justify-between px-8 smooth-hover group">
                    <span>Join existing</span>
                    <span class="group-hover:translate-x-1 transition-transform duration-300"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"></polyline></svg></span>
                </button>
            </div>
        </div>

        <!-- SCREEN 2: HOST -->
        <div id="screen-host" class="hidden flex flex-col h-full animate-scale-in">
            <button onclick="cancelSession()" class="absolute top-0 left-0 mt-4 w-12 h-12 flex items-center justify-center bg-white rounded-full hover:scale-110 transition-transform duration-300 shadow-sm"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#163300" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg></button>
            <div class="flex-1 flex flex-col justify-center items-center text-center">
                <div class="w-24 h-24 bg-wise-dark rounded-full flex items-center justify-center mb-8 shadow-2xl"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#8ED865" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
                <h2 class="text-4xl font-black text-wise-dark mb-4 tracking-tight">Share this code</h2>
                <p class="text-wise-dark/70 font-medium text-lg mb-12">The other person needs this key to join.</p>
                <div class="w-full bg-white p-10 rounded-[2.5rem] mb-12 shadow-[0_20px_60px_-15px_rgba(22,51,0,0.15)] relative overflow-hidden group">
                    <div class="text-6xl font-mono font-bold text-wise-dark tracking-widest relative z-10" id="generated-pin">...</div>
                </div>
                <div class="flex items-center gap-3 px-6 py-3 bg-white/40 rounded-full">
                    <div class="w-3 h-3 bg-white rounded-full animate-bounce"></div><div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div><div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <span class="text-sm font-bold text-wise-dark ml-2">Waiting for peer</span>
                </div>
            </div>
        </div>

        <!-- SCREEN 3: JOIN -->
        <div id="screen-join" class="hidden flex flex-col h-full animate-scale-in">
             <button onclick="cancelSession()" class="absolute top-0 left-0 mt-4 w-12 h-12 flex items-center justify-center bg-white rounded-full hover:scale-110 transition-transform duration-300 shadow-sm"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#163300" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg></button>
            <div class="mt-20 mb-10 text-center">
                <h2 class="text-3xl font-black text-wise-dark mb-2 tracking-tight">Enter access code</h2>
                <div class="h-24 flex items-end justify-center pb-4">
                    <span id="pin-display" class="text-6xl font-bold text-wise-dark tracking-widest min-h-[60px]"></span>
                    <span class="w-[4px] h-12 bg-wise-dark animate-pulse ml-2 mb-2 rounded-full"></span>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-y-6 gap-x-8 max-w-[320px] mx-auto mb-10">
                <button class="keypad-btn text-wise-dark" onclick="pressKey('1')">1</button><button class="keypad-btn text-wise-dark" onclick="pressKey('2')">2</button><button class="keypad-btn text-wise-dark" onclick="pressKey('3')">3</button>
                <button class="keypad-btn text-wise-dark" onclick="pressKey('4')">4</button><button class="keypad-btn text-wise-dark" onclick="pressKey('5')">5</button><button class="keypad-btn text-wise-dark" onclick="pressKey('6')">6</button>
                <button class="keypad-btn text-wise-dark" onclick="pressKey('7')">7</button><button class="keypad-btn text-wise-dark" onclick="pressKey('8')">8</button><button class="keypad-btn text-wise-dark" onclick="pressKey('9')">9</button>
                <button class="keypad-btn text-wise-dark/50 text-base border-none bg-transparent hover:bg-transparent" onclick="clearPin()">Clear</button>
                <button class="keypad-btn text-wise-dark" onclick="pressKey('0')">0</button>
                <button class="keypad-btn text-wise-dark border-none bg-transparent hover:bg-transparent" onclick="backspacePin()"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg></button>
            </div>
            <div class="mt-auto pb-8">
                <button id="btn-connect" onclick="connectToPin()" class="w-full btn-primary h-20 rounded-[2rem] font-bold text-xl disabled:opacity-50 disabled:scale-100 smooth-hover" disabled>Connect</button>
            </div>
        </div>

        <!-- SCREEN 4: STATUS -->
        <div id="screen-status" class="hidden flex flex-col h-full items-center justify-center text-center animate-scale-in">
            <div id="status-icon-container" class="mb-8 relative">
                <div id="status-ping" class="absolute inset-0 bg-white/40 rounded-full animate-ping"></div>
                <div class="relative w-28 h-28 bg-white rounded-full flex items-center justify-center text-5xl shadow-xl"><span id="status-icon">ðŸ“¡</span></div>
            </div>
            <h2 id="status-title" class="text-3xl font-black text-wise-dark mb-4">Connecting</h2>
            <p id="status-desc" class="text-wise-dark/70 font-medium text-lg max-w-[260px] mx-auto">Handshaking securely...</p>
            <div id="debug-info" class="hidden mt-8 p-6 bg-red-100 rounded-2xl text-left w-full border border-red-200 shadow-inner">
                <p class="text-xs font-mono text-red-600 font-bold mb-2 uppercase">Error Log</p>
                <p class="text-sm text-red-900 font-mono break-all leading-relaxed" id="err-msg"></p>
            </div>
            <button onclick="resetApp()" class="mt-12 px-8 py-4 bg-white/20 rounded-full text-wise-dark font-bold hover:bg-white/40 transition-colors">Close</button>
        </div>

        <!-- SCREEN 5: ACTIVE CALL (Fixed Grid) -->
        <div id="screen-active" class="hidden flex flex-col h-full animate-fade-up">
            <div class="text-center mt-8 mb-12">
                <div class="inline-flex items-center gap-2 px-5 py-2 bg-wise-dark rounded-full mb-4 shadow-lg">
                    <div class="w-2 h-2 rounded-full bg-wise-lime animate-pulse"></div>
                    <span class="text-xs font-bold text-wise-lime uppercase tracking-wider">Encrypted</span>
                </div>
                <div id="session-timer" class="text-6xl font-mono font-bold text-wise-dark mt-2 tracking-tighter">00:00</div>
                <div class="flex items-center justify-center gap-3 mt-4">
                    <span class="text-xs font-bold uppercase tracking-widest text-wise-dark/50">Fingerprint</span>
                    <span id="security-fingerprint" class="text-lg grayscale hover:grayscale-0 transition-all cursor-help bg-white/30 px-3 py-1 rounded-lg">ðŸ”’</span>
                </div>
            </div>

            <div class="flex-1 flex items-center justify-center relative my-8">
                <div class="absolute w-[300px] h-[300px] border border-wise-dark/10 rounded-full"></div>
                <div class="absolute w-[220px] h-[220px] border border-wise-dark/20 rounded-full"></div>
                <div id="visualizer-blob" class="w-40 h-40 visualizer-orb shadow-2xl flex items-center justify-center relative z-10">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#8ED865" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                </div>
                <div id="remote-indicator" class="absolute w-40 h-40 bg-white/30 rounded-full z-0 transition-all duration-75 blur-md"></div>
            </div>

            <!-- 3-Column Controls: Speaker, Mute, End -->
            <div class="mt-auto grid grid-cols-3 gap-3 pb-4">
                <button id="btn-speaker" onclick="toggleSpeaker()" class="h-24 rounded-[2.5rem] bg-white flex flex-col items-center justify-center gap-2 smooth-hover shadow-lg">
                    <span id="speaker-icon" class="text-3xl">ðŸ‘‚</span>
                    <span id="speaker-text" class="text-[10px] font-bold uppercase tracking-widest text-wise-dark">Ear</span>
                </button>

                <button id="btn-mute" onclick="toggleMute()" class="h-24 rounded-[2.5rem] bg-white flex flex-col items-center justify-center gap-2 smooth-hover shadow-lg">
                    <span id="mute-icon" class="text-3xl">ðŸŽ¤</span>
                    <span id="mute-text" class="text-[10px] font-bold uppercase tracking-widest text-wise-dark">Mute</span>
                </button>
                
                <button onclick="endSession()" class="h-24 rounded-[2.5rem] bg-[#FF3B30] text-white flex flex-col items-center justify-center gap-2 smooth-hover shadow-lg">
                    <span class="text-3xl">ðŸ“ž</span>
                    <span class="text-[10px] font-bold uppercase tracking-widest">End</span>
                </button>
            </div>
            
            <div class="mt-4 text-center">
                 <p class="text-[10px] font-bold text-wise-dark/40 uppercase tracking-widest">End-to-End Encrypted</p>
            </div>
        </div>
    </main>

    <audio id="remote-audio" autoplay playsinline></audio>

    <script>
        // --- MOBILE FIXES ---
        let isSpeaker = false; // Default to Earpiece
        let backgroundModeEnabled = false;

        document.addEventListener('deviceready', onDeviceReady, false);

        function onDeviceReady() {
            console.log('Running on Android/Cordova');
            
            // 1. Permissions (Audio)
            if (window.cordova && cordova.plugins && cordova.plugins.permissions) {
                const permissions = cordova.plugins.permissions;
                permissions.checkPermission(permissions.RECORD_AUDIO, function( status ){
                    if ( !status.hasPermission ) { permissions.requestPermission(permissions.RECORD_AUDIO, null, null); }
                });
            }

            // 2. Background Mode (CRITICAL FOR LOCK SCREEN)
            // We must set "silent: false" to create a visible notification, otherwise Android kills it.
            if (cordova.plugins && cordova.plugins.backgroundMode) {
                cordova.plugins.backgroundMode.setDefaults({
                    title: 'Wise Voice',
                    text: 'Secure Call in Progress',
                    icon: 'icon', // uses app icon
                    color: '8ED865', // lime color
                    resume: true,
                    hidden: false,
                    silent: false
                });
                cordova.plugins.backgroundMode.enable();
                // Disable WebView pausing optimizations
                cordova.plugins.backgroundMode.on('activate', function() {
                    cordova.plugins.backgroundMode.disableWebViewOptimizations(); 
                });
            }

            // 3. Keep Awake
            if(window.plugins && window.plugins.insomnia) {
                window.plugins.insomnia.keepAwake();
            }
            
            // 4. Initial Audio Mode: Force EARPIECE on startup
            if(window.AudioToggle) {
                window.AudioToggle.setAudioMode(window.AudioToggle.EARPIECE);
                updateSpeakerUI();
            }
        }

        function toggleSpeaker() {
            if (!window.AudioToggle) { isSpeaker = !isSpeaker; updateSpeakerUI(); return; }
            
            isSpeaker = !isSpeaker;
            if (isSpeaker) {
                window.AudioToggle.setAudioMode(window.AudioToggle.SPEAKER);
            } else {
                window.AudioToggle.setAudioMode(window.AudioToggle.EARPIECE);
            }
            updateSpeakerUI();
        }

        function updateSpeakerUI() {
            const btn = document.getElementById('btn-speaker');
            const icon = document.getElementById('speaker-icon');
            const txt = document.getElementById('speaker-text');
            
            if (isSpeaker) {
                btn.className = "h-24 rounded-[2.5rem] bg-wise-dark text-white flex flex-col items-center justify-center gap-2 smooth-hover shadow-lg border-2 border-wise-dark";
                icon.innerText = "ðŸ”Š"; txt.innerText = "Loud"; txt.classList.remove('text-wise-dark'); txt.classList.add('text-white');
            } else {
                btn.className = "h-24 rounded-[2.5rem] bg-white flex flex-col items-center justify-center gap-2 smooth-hover shadow-lg";
                icon.innerText = "ðŸ‘‚"; txt.innerText = "Ear"; txt.classList.add('text-wise-dark'); txt.classList.remove('text-white');
            }
        }

        // --- CORE APP LOGIC ---
        let peer, localStream, activeCall, currentPin = '', timerInterval, isMuted = false, reconnectTimer;
        let audioContext, analyser, dataArray;
        const PREFIX = 'aeon-secure-v33-';

        function showScreen(id) {
            ['screen-mode', 'screen-host', 'screen-join', 'screen-status', 'screen-active'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.getElementById('connection-status').classList.toggle('hidden', id === 'screen-mode');
            document.getElementById('reconnecting-warning').classList.add('hidden');
        }

        function updateStatusDot(state) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const states = { online: ['bg-wise-lime animate-pulse', 'Online'], waiting: ['bg-yellow-400 animate-pulse', 'Waiting'], error: ['bg-red-500', 'Error'], ended: ['bg-gray-400', 'Offline'] };
            const s = states[state] || states.ended;
            dot.className = `w-2 h-2 rounded-full ${s[0]}`; text.innerText = s[1];
        }

        function cancelSession() { cleanupSession(); stopTimer(); resetApp(); }
        function resetApp() {
            cleanupSession(); clearTimeout(reconnectTimer);
            document.getElementById('reconnecting-warning').classList.add('hidden');
            currentPin = ''; document.getElementById('pin-display').innerText = '';
            updateConnectBtn(); isMuted = false; updateMuteUI(); isSpeaker = false; updateSpeakerUI();
            showScreen('screen-mode'); updateStatusDot('offline');
        }
        function endSession() { if (activeCall) activeCall.close(); cancelSession(); }

        function cleanupSession() {
            if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
            if (peer) { peer.destroy(); peer = null; }
            if (audioContext) { audioContext.close(); audioContext = null; }
            activeCall = null;
        }

        async function requestAudio() {
            return await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } });
        }

        function toggleMute() {
            if (!localStream) return;
            const track = localStream.getAudioTracks()[0];
            if (!track) return;
            isMuted = !isMuted;
            track.enabled = !isMuted;
            updateMuteUI();
        }

        function updateMuteUI() {
            const btn = document.getElementById('btn-mute'), icon = document.getElementById('mute-icon'), txt = document.getElementById('mute-text');
            if (isMuted) {
                btn.className = "h-24 rounded-[2.5rem] bg-red-100 flex flex-col items-center justify-center gap-2 smooth-hover shadow-lg border-2 border-red-200";
                icon.innerText = "ðŸ”‡"; txt.innerText = "Unmute";
            } else {
                btn.className = "h-24 rounded-[2.5rem] bg-white flex flex-col items-center justify-center gap-2 smooth-hover shadow-lg";
                icon.innerText = "ðŸŽ¤"; txt.innerText = "Mute";
            }
        }

        async function goToHost() {
            const pin = Math.floor(100000 + Math.random() * 900000).toString();
            showScreen('screen-host');
            document.getElementById('generated-pin').innerText = `${pin.slice(0, 3)} ${pin.slice(3)}`;
            updateStatusDot('waiting');
            peer = new Peer(PREFIX + pin);
            peer.on('call', async (call) => {
                updateStatusDot('online');
                try { localStream = await requestAudio(); isMuted = false; updateMuteUI(); } 
                catch (e) { call.close(); return; }
                initVisualizer(localStream); handleCall(call);
            });
            peer.on('error', (err) => { if(err.type==='unavailable-id') { peer.destroy(); setTimeout(goToHost,500); } });
        }

        function goToJoin() { showScreen('screen-join'); updateStatusDot('offline'); }
        function pressKey(key) { if (currentPin.length < 6) { currentPin += key; updatePinDisplay(); } }
        function backspacePin() { currentPin = currentPin.slice(0, -1); updatePinDisplay(); }
        function clearPin() { currentPin = ''; updatePinDisplay(); }
        function updatePinDisplay() {
            let display = currentPin.length > 3 ? currentPin.slice(0, 3) + ' ' + currentPin.slice(3) : currentPin;
            document.getElementById('pin-display').innerText = display;
            updateConnectBtn();
        }
        function updateConnectBtn() { document.getElementById('btn-connect').disabled = currentPin.length !== 6; }

        async function connectToPin() {
            showScreen('screen-status');
            updateStatusDot('waiting');
            try { localStream = await requestAudio(); } catch (e) { return; }
            initVisualizer(localStream);
            peer = new Peer();
            peer.on('open', (id) => {
                const call = peer.call(PREFIX + currentPin, localStream);
                const timeout = setTimeout(() => { if (!activeCall) { if (peer) peer.destroy(); showScreen('screen-join'); } }, 8000);
                handleCall(call, timeout);
            });
        }

        function handleCall(call, timeoutTimer = null) {
            if (timeoutTimer) clearTimeout(timeoutTimer);
            call.answer(localStream); activeCall = call;
            call.on('stream', (remoteStream) => {
                if (timeoutTimer) clearTimeout(timeoutTimer);
                document.getElementById('remote-audio').srcObject = remoteStream;
                showScreen('screen-active'); updateStatusDot('online'); startTimer(); generateFingerprint(); startVisualizerLoop();
                
                // --- FORCE AUDIO FIX ---
                // We force earpiece mode shortly after connection to override WebRTC defaults
                if(window.AudioToggle) {
                    setTimeout(() => {
                        window.AudioToggle.setAudioMode(window.AudioToggle.EARPIECE);
                        // Also ensure background mode is active
                        if(cordova.plugins && cordova.plugins.backgroundMode) {
                            cordova.plugins.backgroundMode.moveToBackground(); // Optional: keeps it aggressive
                            cordova.plugins.backgroundMode.wakeUp();
                        }
                    }, 1000);
                }
            });
            call.on('close', () => { cleanupSession(); showScreen('screen-mode'); });
            call.on('error', (e) => console.log(e));
        }

        function initVisualizer(stream) {
            if(!stream) return;
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser(); analyser.fftSize = 64; source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
        }

        function startVisualizerLoop() {
            if(!analyser) return;
            const blob = document.getElementById('visualizer-blob');
            function renderFrame() {
                if (document.getElementById('screen-active').classList.contains('hidden')) return;
                requestAnimationFrame(renderFrame);
                analyser.getByteFrequencyData(dataArray);
                let sum = 0; for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
                const average = sum / dataArray.length;
                blob.style.transform = `scale(${1 + (average / 256) * 0.8})`;
            }
            renderFrame();
        }

        function generateFingerprint() {
            const icons = ['ðŸ”’', 'ðŸ›¡ï¸', 'âš”ï¸', 'ðŸ‘ï¸', 'ðŸ—ï¸', 'ðŸ§¬', 'â˜¢ï¸', 'âš¡', 'ðŸª', 'âš“'];
            let seed = parseInt(currentPin || '123456'); if (isNaN(seed)) seed = Date.now();
            let result = '';
            for (let i = 0; i < 4; i++) { seed = (seed * 9301 + 49297) % 233280; result += icons[Math.floor((seed / 233280) * icons.length)] + ' '; }
            document.getElementById('security-fingerprint').innerText = result;
        }

        function startTimer() { let sec = 0; const el = document.getElementById('session-timer'); clearInterval(timerInterval); timerInterval = setInterval(() => { sec++; el.innerText = `${Math.floor(sec / 60).toString().padStart(2, '0')}:${(sec % 60).toString().padStart(2, '0')}`; }, 1000); }
        function stopTimer() { clearInterval(timerInterval); }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' gap: data: blob: filesystem:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'; media-src *">
    <title>Wise Voice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800;900&display=swap" rel="stylesheet">
    <script src="cordova.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 'wise-lime': '#8ED865', 'wise-dark': '#163300' },
                    animation: { 'fade-up': 'fadeUp 0.8s forwards' },
                    keyframes: { fadeUp: { '0%': { opacity: '0', transform: 'translateY(40px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #8ED865; color: #163300; -webkit-tap-highlight-color: transparent; user-select: none; }
        .btn-primary { background-color: #163300; color: #ffffff; }
        .btn-secondary { background-color: #ffffff; color: #163300; }
        .visualizer-orb { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; background: #163300; transition: all 0.1s ease; }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden relative">

    <div id="connection-status" class="hidden absolute top-6 right-6 z-30 animate-fade-up">
        <div class="flex items-center gap-2 px-4 py-2 bg-white/90 backdrop-blur-sm rounded-full shadow-lg">
            <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-400"></div>
            <span id="status-text" class="text-xs font-bold uppercase tracking-wide opacity-80">Offline</span>
        </div>
    </div>

    <main class="flex-1 w-full max-w-lg mx-auto p-6 relative z-10 flex flex-col justify-center">
        <!-- SCREEN 1: MODE SELECTION -->
        <div id="screen-mode" class="flex flex-col h-full justify-between py-12">
            <div class="flex-1 flex flex-col justify-center">
                <h1 class="text-[5rem] sm:text-[6rem] font-black leading-[0.85] tracking-tighter text-wise-dark mb-8">
                    Voice<br>calls<br><span class="text-white">secure.</span>
                </h1>
            </div>
            <div class="space-y-4 mb-4">
                <button onclick="goToHost()" class="w-full btn-primary h-20 rounded-[2rem] font-bold text-xl flex items-center justify-between px-8"><span>Create Room</span></button>
                <button onclick="goToJoin()" class="w-full btn-secondary h-20 rounded-[2rem] font-bold text-xl flex items-center justify-between px-8"><span>Join Existing</span></button>
            </div>
        </div>

        <!-- SCREEN 2: HOST -->
        <div id="screen-host" class="hidden flex flex-col h-full items-center justify-center text-center">
            <button onclick="resetApp()" class="absolute top-4 left-4 p-4 bg-white rounded-full">âœ•</button>
            <h2 class="text-4xl font-black text-wise-dark mb-4">Share Code</h2>
            <div class="w-full bg-white p-10 rounded-[2.5rem] mb-12 shadow-xl">
                <div class="text-6xl font-mono font-bold text-wise-dark tracking-widest" id="generated-pin">...</div>
            </div>
            <p class="animate-pulse font-bold">Waiting for peer...</p>
        </div>

        <!-- SCREEN 3: JOIN -->
        <div id="screen-join" class="hidden flex flex-col h-full pt-20">
            <button onclick="resetApp()" class="absolute top-4 left-4 p-4 bg-white rounded-full">âœ•</button>
            <h2 class="text-3xl font-black text-wise-dark mb-2 text-center">Enter Code</h2>
            <div class="h-24 flex items-end justify-center pb-4 mb-8">
                <span id="pin-display" class="text-6xl font-bold text-wise-dark tracking-widest"></span>
            </div>
            <div class="grid grid-cols-3 gap-4 max-w-[300px] mx-auto mb-10">
                <button class="h-16 rounded-full bg-white/30 font-bold text-xl" onclick="pressKey('1')">1</button>
                <button class="h-16 rounded-full bg-white/30 font-bold text-xl" onclick="pressKey('2')">2</button>
                <button class="h-16 rounded-full bg-white/30 font-bold text-xl" onclick="pressKey('3')">3</button>
                <button class="h-16 rounded-full bg-white/30 font-bold text-xl" onclick="pressKey('4')">4</button>
                <button class="h-16 rounded-full bg-white/30 font-bold text-xl" onclick="pressKey('5')">5</button>
                <button class="h-16 rounded-full bg-white/30 font-bold text-xl" onclick="pressKey('6')">6</button>
                <button class="h-16 rounded-full bg-white/30 font-bold text-xl" onclick="pressKey('7')">7</button>
                <button class="h-16 rounded-full bg-white/30 font-bold text-xl" onclick="pressKey('8')">8</button>
                <button class="h-16 rounded-full bg-white/30 font-bold text-xl" onclick="pressKey('9')">9</button>
                <button class="h-16 rounded-full bg-transparent font-bold text-sm" onclick="clearPin()">Clear</button>
                <button class="h-16 rounded-full bg-white/30 font-bold text-xl" onclick="pressKey('0')">0</button>
                <button class="h-16 rounded-full bg-transparent font-bold text-xl" onclick="backspacePin()">âŒ«</button>
            </div>
            <button id="btn-connect" onclick="connectToPin()" class="w-full btn-primary h-20 rounded-[2rem] font-bold text-xl" disabled>Connect</button>
        </div>

        <!-- SCREEN 4: ACTIVE CALL -->
        <div id="screen-active" class="hidden flex flex-col h-full">
            <div class="text-center mt-12 mb-12">
                <div class="inline-flex items-center gap-2 px-5 py-2 bg-wise-dark rounded-full mb-4 shadow-lg">
                    <div class="w-2 h-2 rounded-full bg-wise-lime animate-pulse"></div>
                    <span class="text-xs font-bold text-wise-lime uppercase">Encrypted Call</span>
                </div>
                <div id="session-timer" class="text-6xl font-mono font-bold text-wise-dark mt-2">00:00</div>
            </div>

            <div class="flex-1 flex items-center justify-center relative">
                <div id="visualizer-blob" class="w-40 h-40 visualizer-orb shadow-2xl flex items-center justify-center">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#8ED865" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path></svg>
                </div>
            </div>

            <div class="mt-auto grid grid-cols-3 gap-3 pb-8">
                <!-- SPEAKER BUTTON -->
                <button id="btn-speaker" onclick="toggleSpeaker()" class="h-24 rounded-[2.5rem] bg-white flex flex-col items-center justify-center gap-2 shadow-lg">
                    <span id="speaker-icon" class="text-3xl">ðŸ‘‚</span>
                    <span id="speaker-text" class="text-[10px] font-bold uppercase text-wise-dark">Ear</span>
                </button>
                <!-- MUTE BUTTON -->
                <button id="btn-mute" onclick="toggleMute()" class="h-24 rounded-[2.5rem] bg-white flex flex-col items-center justify-center gap-2 shadow-lg">
                    <span id="mute-icon" class="text-3xl">ðŸŽ¤</span>
                    <span id="mute-text" class="text-[10px] font-bold uppercase text-wise-dark">Mute</span>
                </button>
                <!-- END BUTTON -->
                <button onclick="endSession()" class="h-24 rounded-[2.5rem] bg-[#FF3B30] text-white flex flex-col items-center justify-center gap-2 shadow-lg">
                    <span class="text-3xl">ðŸ“ž</span>
                    <span class="text-[10px] font-bold uppercase">End</span>
                </button>
            </div>
        </div>
    </main>

    <audio id="remote-audio" autoplay playsinline></audio>

    <script>
        // --- CORE LOGIC ---
        let peer, localStream, activeCall;
        let isSpeaker = false;
        let isMuted = false;
        let timerInterval;
        let currentPin = '';
        const PREFIX = 'wise-secure-v1-';

        document.addEventListener('deviceready', onDeviceReady, false);

        function onDeviceReady() {
            // 1. Configure Background Mode (Do NOT enable yet)
            if (cordova.plugins.backgroundMode) {
                cordova.plugins.backgroundMode.setDefaults({
                    title: "Wise Voice",
                    text: "Secure call in progress",
                    icon: 'icon', 
                    color: "163300",
                    resume: true,
                    hidden: false,
                    bigText: false
                });
                // Fix for Android 12+ optimization killing
                cordova.plugins.backgroundMode.on('activate', function() {
                    cordova.plugins.backgroundMode.disableWebViewOptimizations(); 
                });
            }

            // 2. Request Permissions (Sequence is critical to prevent crashes)
            const permissions = cordova.plugins.permissions;
            if (permissions) {
                const list = [
                    permissions.RECORD_AUDIO,
                    permissions.MODIFY_AUDIO_SETTINGS,
                    permissions.BLUETOOTH_CONNECT, // Android 12+ Crash Fix
                    permissions.POST_NOTIFICATIONS // Android 13+ Crash Fix
                ];
                permissions.requestPermissions(list, 
                    function(status) { console.log('Permissions granted'); },
                    function(err) { console.warn('Permissions denied', err); }
                );
            }

            // 3. Keep Awake
            if(window.plugins && window.plugins.insomnia) {
                window.plugins.insomnia.keepAwake();
            }

            // 4. Set Default Audio Mode
            if(window.AudioToggle) {
                window.AudioToggle.setAudioMode(window.AudioToggle.EARPIECE);
            }
        }

        // --- AUDIO HANDLING ---
        function toggleSpeaker() {
            if (!window.AudioToggle) {
                alert("Audio plugin not loaded");
                return;
            }
            
            isSpeaker = !isSpeaker;
            const mode = isSpeaker ? window.AudioToggle.SPEAKER : window.AudioToggle.EARPIECE;
            
            window.AudioToggle.setAudioMode(mode);
            updateSpeakerUI();
        }

        function updateSpeakerUI() {
            const btn = document.getElementById('btn-speaker');
            const icon = document.getElementById('speaker-icon');
            const txt = document.getElementById('speaker-text');
            
            if (isSpeaker) {
                btn.classList.replace('bg-white', 'bg-wise-dark');
                btn.classList.add('text-white');
                icon.innerText = "ðŸ”Š";
                txt.innerText = "Speaker";
                txt.classList.replace('text-wise-dark', 'text-white');
            } else {
                btn.classList.replace('bg-wise-dark', 'bg-white');
                btn.classList.remove('text-white');
                icon.innerText = "ðŸ‘‚";
                txt.innerText = "Ear";
                txt.classList.replace('text-white', 'text-wise-dark');
            }
        }

        // --- BACKGROUND MODE MANAGEMENT ---
        function enableBackgroundMode() {
            if (cordova.plugins && cordova.plugins.backgroundMode) {
                cordova.plugins.backgroundMode.enable();
            }
        }

        function disableBackgroundMode() {
            if (cordova.plugins && cordova.plugins.backgroundMode) {
                cordova.plugins.backgroundMode.disable();
            }
        }

        // --- APP FLOW ---
        function showScreen(id) {
            ['screen-mode', 'screen-host', 'screen-join', 'screen-active'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function goToHost() {
            const pin = Math.floor(100000 + Math.random() * 900000).toString();
            document.getElementById('generated-pin').innerText = pin.slice(0,3) + ' ' + pin.slice(3);
            showScreen('screen-host');
            
            peer = new Peer(PREFIX + pin);
            peer.on('call', async (call) => {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    handleCall(call);
                } catch(e) { alert("Mic Error: " + e); }
            });
        }

        function goToJoin() {
            showScreen('screen-join');
        }

        function connectToPin() {
            if(currentPin.length !== 6) return;
            peer = new Peer();
            peer.on('open', async () => {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const call = peer.call(PREFIX + currentPin, localStream);
                    handleCall(call);
                } catch(e) { alert("Mic Error: " + e); }
            });
        }

        function handleCall(call) {
            call.answer(localStream);
            activeCall = call;
            
            call.on('stream', (remoteStream) => {
                document.getElementById('remote-audio').srcObject = remoteStream;
                showScreen('screen-active');
                
                // CRITICAL: Enable background mode ONLY when call starts
                enableBackgroundMode();
                
                // CRITICAL: Ensure audio starts in Earpiece mode
                if(window.AudioToggle) window.AudioToggle.setAudioMode(window.AudioToggle.EARPIECE);
                isSpeaker = false;
                updateSpeakerUI();
                
                startTimer();
                initVisualizer(localStream);
            });
            
            call.on('close', endSession);
            call.on('error', endSession);
        }

        function endSession() {
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            if(activeCall) activeCall.close();
            if(peer) peer.destroy();
            
            // CRITICAL: Disable background mode when call ends
            disableBackgroundMode();
            
            clearInterval(timerInterval);
            resetApp();
        }

        function resetApp() {
            currentPin = '';
            document.getElementById('pin-display').innerText = '';
            document.getElementById('btn-connect').disabled = true;
            showScreen('screen-mode');
        }

        // --- UTILS (Keypad, Timer, Visualizer) ---
        function pressKey(k) { if(currentPin.length < 6) { currentPin += k; updatePinDisplay(); } }
        function backspacePin() { currentPin = currentPin.slice(0, -1); updatePinDisplay(); }
        function clearPin() { currentPin = ''; updatePinDisplay(); }
        function updatePinDisplay() { 
            document.getElementById('pin-display').innerText = currentPin; 
            document.getElementById('btn-connect').disabled = currentPin.length !== 6; 
        }
        function startTimer() {
            let sec = 0;
            const el = document.getElementById('session-timer');
            timerInterval = setInterval(() => {
                sec++;
                el.innerText = Math.floor(sec/60).toString().padStart(2,'0') + ':' + (sec%60).toString().padStart(2,'0');
            }, 1000);
        }
        function toggleMute() {
            if(!localStream) return;
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            document.getElementById('btn-mute').classList.toggle('bg-red-200');
        }
        function initVisualizer(stream) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const source = ctx.createMediaStreamSource(stream);
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 64;
            source.connect(analyser);
            const data = new Uint8Array(analyser.frequencyBinCount);
            const blob = document.getElementById('visualizer-blob');
            function loop() {
                if(document.getElementById('screen-active').classList.contains('hidden')) return;
                requestAnimationFrame(loop);
                analyser.getByteFrequencyData(data);
                const avg = data.reduce((a,b)=>a+b,0) / data.length;
                blob.style.transform = `scale(${1 + (avg/256)*0.8})`;
            }
            loop();
        }
    </script>
</body>
</html>